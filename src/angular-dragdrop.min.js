/**
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to
 * deal in the Software without restriction, including without limitation the
 * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 */

/**
 * Implementing Drag and Drop functionality in AngularJS is easier than ever.
 * Demo: http://codef0rmer.github.com/angular-dragdrop/
 * 
 * @version 1.0.0
 *
 * (c) 2013 Amit Gharat a.k.a codef0rmer <amit.2006.it@gmail.com> - amitgharat.wordpress.com
 */
 
var jqyoui=angular.module("ngDragDrop",[]).directive("jqyouiDraggable",function(){return{require:"?jqyouiDroppable",restrict:"A",link:function(e,t,a){var i,o=function(o){o?(i=e.$eval(t.attr("jqyoui-draggable"))||[],t.draggable({disabled:!1}).draggable(e.$eval(a.jqyouiOptions)||{}).draggable({start:function(t,a){$(this).css("z-index",99999),jqyoui.startXY=$(this).offset(),i.onStart&&e[i.onStart](t,a)},stop:function(t,a){i.onStop&&e[i.onStop](t,a)},drag:function(t,a){i.onDrag&&e[i.onDrag](t,a)}})):t.draggable({disabled:!0})};e.$watch(function(){return e.$eval(a.drag)},o),o()}}}).directive("jqyouiDroppable",["$timeout",function(e){return{restrict:"A",priority:1,link:function(t,a,i){var o=function(o){o?a.droppable({disabled:!1}).droppable(t.$eval(i.jqyouiOptions)||{}).droppable({over:function(e,a){var i=t.$eval(angular.element(this).attr("jqyoui-droppable"))||[];i.onOver&&t[i.onOver](e,a)},out:function(e,a){var i=t.$eval(angular.element(this).attr("jqyoui-droppable"))||[];i.onOut&&t[i.onOut](e,a)},drop:function(a,i){jqyoui.invokeDrop(angular.element(i.draggable),angular.element(this),t,e,a,i)}}):a.droppable({disabled:!0})};t.$watch(function(){return t.$eval(i.drop)},o),o()}}}]);jqyoui.invokeDrop=function(e,t,a,i,o,n){var r="",l="",u={},s={},p=null,d={},g={},c=null;r=e.attr("ng-model"),l=t.attr("ng-model"),c=t.find("[jqyoui-draggable]:last"),s=a.$eval(t.attr("jqyoui-droppable"))||[],u=a.$eval(e.attr("jqyoui-draggable"))||[],p=angular.isArray(a[r])?u.index:null,d=angular.isArray(a[r])?a[r][p]:a[r],g=(angular.isArray(a[l])&&s&&void 0!==s.index?a[l][s.index]:angular.isArray(a[l])?{}:a[l])||{},u.animate===!0?(jqyoui.move(e,c.length>0?c:t,null,"fast",s,null),jqyoui.move(c.length>0&&!s.multiple?c:[],e.parent("[jqyoui-droppable]"),jqyoui.startXY,"fast",s,function(){i(function(){e.css({position:"relative",left:"",top:""}),c.css({position:"relative",left:"",top:""}),jqyoui.mutateDraggable(a,s,u,r,l,g,e),jqyoui.mutateDroppable(a,s,u,l,d,p),s.onDrop&&a[s.onDrop](o,n)})})):i(function(){jqyoui.mutateDraggable(a,s,u,r,l,g,e),jqyoui.mutateDroppable(a,s,u,l,d,p),s.onDrop&&a[s.onDrop](o,n)})},jqyoui.move=function(e,t,a,i,o,n){if(0===e.length)return n&&window.setTimeout(function(){n()},300),!1;var r=9999,l=e.offset(),u=t&&t.is(":visible");null===a&&t.length>0&&(void 0!==t.attr("jqyoui-draggable")&&void 0!==t.attr("ng-model")&&t.is(":visible")&&o&&o.multiple?(a=t.offset(),o.stack===!1?a.left+=t.outerWidth(!0):a.top+=t.outerHeight(!0)):(a=t.css({visibility:"hidden",display:"block"}).offset(),t.css({visibility:"",display:u?"":"none"}))),e.css({position:"absolute","z-index":r}).css(l).animate(a,i,function(){n&&n()})},jqyoui.mutateDroppable=function(e,t,a,i,o,n){angular.isArray(e[i])?(t&&t.index>=0?e[i][t.index]=o:e[i].push(o),a&&a.placeholder===!0&&(e[i][e[i].length-1].jqyoui_pos=n)):(e[i]=o,a&&a.placeholder===!0&&(e[i].jqyoui_pos=n))},jqyoui.mutateDraggable=function(e,t,a,i,o,n,r){var l=$.isEmptyObject(n);a&&a.placeholder?"keep"!=a.placeholder&&(angular.isArray(e[i])&&void 0!==a.index?e[i][a.index]=n:e[i]=n):angular.isArray(e[i])?l?a&&!a.immutable&&e[i].splice(a.index,1):e[i][a.index]=n:(e[i]=n,e.$parent&&(e.$parent[i]=n)),r.css({"z-index":"",left:"",top:""})};