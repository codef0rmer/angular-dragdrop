/**
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to
 * deal in the Software without restriction, including without limitation the
 * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 */

/**
 * Implementing Drag and Drop functionality in AngularJS is easier than ever.
 * Demo: http://codef0rmer.github.com/angular-dragdrop/
 * 
 * @version 1.0.0
 *
 * (c) 2013 Amit Gharat a.k.a codef0rmer <amit.2006.it@gmail.com> - amitgharat.wordpress.com
 */
var jqyoui=angular.module("ngDragDrop",[]).directive("jqyouiDraggable",function(){return{require:"?jqyouiDroppable",restrict:"A",link:function(scope,element,attrs){var dragSettings,updateDraggable=function(newValue,oldValue){newValue?(dragSettings=scope.$eval(element.attr("jqyoui-draggable"))||[],element.draggable({disabled:!1}).draggable(scope.$eval(attrs.jqyouiOptions)||{}).draggable({start:function(event,ui){$(this).css("z-index",99999),jqyoui.startXY=$(this).offset(),dragSettings.onStart&&(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/.test(dragSettings.onStart)?(dragSettings.startFunc=dragSettings.onStart.match(/^[a-zA-Z0-9_\$]*\(/),dragSettings.startFunc=dragSettings.startFunc[0].substr(0,dragSettings.startFunc[0].length-1),dragSettings.startInput=(""+dragSettings.onStart.match(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/)).replace(/\(/,"").replace(/\)/,""),eval("scope[dragSettings.startFunc](event, ui, "+dragSettings.startInput+")")):scope[dragSettings.onStart](event,ui))},stop:function(event,ui){dragSettings.onStop&&(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/.test(dragSettings.onStop)?(dragSettings.stopFunc=dragSettings.onStop.match(/^[a-zA-Z0-9_\$]*\(/),dragSettings.stopFunc=dragSettings.stopFunc[0].substr(0,dragSettings.stopFunc[0].length-1),dragSettings.stopInput=(""+dragSettings.onStop.match(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/)).replace(/\(/,"").replace(/\)/,""),eval("scope[dragSettings.stopFunc](event, ui, "+dragSettings.stopInput+")")):scope[dragSettings.onStop](event,ui))},drag:function(event,ui){dragSettings.onDrag&&(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/.test(dragSettings.onDrag)?(dragSettings.dragFunc=dragSettings.onDrag.match(/^[a-zA-Z0-9_\$]*\(/),dragSettings.dragFunc=dragSettings.dragFunc[0].substr(0,dragSettings.dragFunc[0].length-1),dragSettings.dragInput=(""+dragSettings.onDrag.match(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/)).replace(/\(/,"").replace(/\)/,""),eval("scope[dragSettings.dragFunc](event, ui, "+dragSettings.dropInput+")")):scope[dragSettings.onDrag](event,ui))}})):element.draggable({disabled:!0})};scope.$watch(function(){return scope.$eval(attrs.drag)},updateDraggable),updateDraggable()}}}).directive("jqyouiDroppable",["$timeout",function($timeout){return{restrict:"A",priority:1,link:function(scope,element,attrs){var updateDroppable=function(newValue,oldValue){newValue?element.droppable({disabled:!1}).droppable(scope.$eval(attrs.jqyouiOptions)||{}).droppable({over:function(event,ui){var dropSettings=scope.$eval(angular.element(this).attr("jqyoui-droppable"))||[];dropSettings.onOver&&(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/.test(dropSettings.onOver)?(dropSettings.overFunc=dropSettings.onOver.match(/^[a-zA-Z0-9_\$]*\(/),dropSettings.overFunc=dropSettings.overFunc[0].substr(0,dropSettings.overFunc[0].length-1),dropSettings.overInput=(""+dropSettings.onOver.match(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/)).replace(/\(/,"").replace(/\)/,""),eval("scope[dropSettings.overFunc](event, ui, "+dropSettings.overInput+")")):scope[dropSettings.onOver](event,ui))},out:function(event,ui){var dropSettings=scope.$eval(angular.element(this).attr("jqyoui-droppable"))||[];dropSettings.onOut&&(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/.test(dropSettings.onOut)?(dropSettings.outFunc=dropSettings.onOut.match(/^[a-zA-Z0-9_\$]*\(/),dropSettings.outFunc=dropSettings.outFunc[0].substr(0,dropSettings.outFunc[0].length-1),dropSettings.outInput=(""+dropSettings.onOut.match(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/)).replace(/\(/,"").replace(/\)/,""),eval("scope[dropSettings.outFunc](event, ui, "+dropSettings.outInput+")")):scope[dropSettings.onOut](event,ui))},drop:function(t,e){jqyoui.invokeDrop(angular.element(e.draggable),angular.element(this),scope,$timeout,t,e)}}):element.droppable({disabled:!0})};scope.$watch(function(){return scope.$eval(attrs.drop)},updateDroppable),updateDroppable()}}}]);jqyoui.invokeDrop=function($draggable,$droppable,scope,$timeout,event,ui){var dragModel="",dropModel="",dragSettings={},dropSettings={},jqyoui_pos=null,dragItem={},dropItem={},$droppableDraggable=null;dragModel=$draggable.attr("ng-model"),dropModel=$droppable.attr("ng-model"),$droppableDraggable=$droppable.find("[jqyoui-draggable]:last"),dropSettings=scope.$eval($droppable.attr("jqyoui-droppable"))||[],dragSettings=scope.$eval($draggable.attr("jqyoui-draggable"))||[],jqyoui_pos=angular.isArray(scope[dragModel])?dragSettings.index:null,dragItem=angular.isArray(scope[dragModel])?scope[dragModel][jqyoui_pos]:scope[dragModel],dropItem=(angular.isArray(scope[dropModel])&&dropSettings&&void 0!==dropSettings.index?scope[dropModel][dropSettings.index]:angular.isArray(scope[dropModel])?{}:scope[dropModel])||{},dragSettings.animate===!0?(jqyoui.move($draggable,$droppableDraggable.length>0?$droppableDraggable:$droppable,null,"fast",dropSettings,null),jqyoui.move($droppableDraggable.length>0&&!dropSettings.multiple?$droppableDraggable:[],$draggable.parent("[jqyoui-droppable]"),jqyoui.startXY,"fast",dropSettings,function(){$timeout(function(){$draggable.css({position:"relative",left:"",top:""}),$droppableDraggable.css({position:"relative",left:"",top:""}),jqyoui.mutateDraggable(scope,dropSettings,dragSettings,dragModel,dropModel,dropItem,$draggable),jqyoui.mutateDroppable(scope,dropSettings,dragSettings,dropModel,dragItem,jqyoui_pos),dropSettings.onDrop&&(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/.test(dropSettings.onDrop)?(dropSettings.dropFunc=dropSettings.onDrop.match(/^[a-zA-Z0-9_\$]*\(/),dropSettings.dropFunc=dropSettings.dropFunc[0].substr(0,dropSettings.dropFunc[0].length-1),dropSettings.dropInput=(""+dropSettings.onDrop.match(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/)).replace(/\(/,"").replace(/\)/,""),eval("scope[dropSettings.dropFunc](event, ui, "+dropSettings.dropInput+")")):scope[dropSettings.onDrop](event,ui))})})):$timeout(function(){jqyoui.mutateDraggable(scope,dropSettings,dragSettings,dragModel,dropModel,dropItem,$draggable),jqyoui.mutateDroppable(scope,dropSettings,dragSettings,dropModel,dragItem,jqyoui_pos),dropSettings.onDrop&&(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/.test(dropSettings.onDrop)?(dropSettings.dropFunc=dropSettings.onDrop.match(/^[a-zA-Z0-9_\$]*\(/),dropSettings.dropFunc=dropSettings.dropFunc[0].substr(0,dropSettings.dropFunc[0].length-1),dropSettings.dropInput=(""+dropSettings.onDrop.match(/\([a-zA-Z0-9_,:\'\s\$\[\]\{\}\.]*\)/)).replace(/\(/,"").replace(/\)/,""),eval("scope[dropSettings.dropFunc](event, ui, "+dropSettings.dropInput+")")):scope[dropSettings.onDrop](event,ui))})},jqyoui.move=function(t,e,o,r,n,a){if(0===t.length)return a&&window.setTimeout(function(){a()},300),!1;var p=9999,i=t.offset(),s=e&&e.is(":visible");null===o&&e.length>0&&(void 0!==e.attr("jqyoui-draggable")&&void 0!==e.attr("ng-model")&&e.is(":visible")&&n&&n.multiple?(o=e.offset(),n.stack===!1?o.left+=e.outerWidth(!0):o.top+=e.outerHeight(!0)):(o=e.css({visibility:"hidden",display:"block"}).offset(),e.css({visibility:"",display:s?"":"none"}))),t.css({position:"absolute","z-index":p}).css(i).animate(o,r,function(){a&&a()})},jqyoui.mutateDroppable=function(t,e,o,r,n,a){angular.isArray(t[r])?(e&&e.index>=0?t[r][e.index]=n:t[r].push(n),o&&o.placeholder&&(t[r][t[r].length-1].jqyoui_pos=a)):(t[r]=n,o&&o.placeholder&&(t[r].jqyoui_pos=a))},jqyoui.mutateDraggable=function(t,e,o,r,n,a,p){var i=$.isEmptyObject(a);o&&o.placeholder?angular.isArray(t[r])&&void 0!==o.index?t[r][o.index]=a:t[r]=a:angular.isArray(t[r])?i?t[r].splice(o.index,1):t[r][o.index]=a:(t[r]=a,t.$parent&&(t.$parent[r]=a)),p.css({"z-index":"",left:"",top:""})};